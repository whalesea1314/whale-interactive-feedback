name: Update Homebrew Formula

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Release tag name (e.g., v0.1.0)'
        required: true
        type: string

jobs:
  update-homebrew:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

      - name: Get release information
        id: release_info
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            TAG_NAME="${{ github.event.release.tag_name }}"
          else
            TAG_NAME="${{ github.event.inputs.tag_name }}"
          fi

          VERSION_NUMBER=${TAG_NAME#v}
          echo "tag_name=${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "version_number=${VERSION_NUMBER}" >> $GITHUB_OUTPUT
          echo "Release tag: ${TAG_NAME}"
          echo "Version number: ${VERSION_NUMBER}"

      - name: Verify release assets exist
        run: |
          TAG_NAME="${{ steps.release_info.outputs.tag_name }}"
          REPO_OWNER="${{ github.repository_owner }}"
          REPO_NAME="${{ github.event.repository.name }}"

          INTEL_URL="https://github.com/${REPO_OWNER}/${REPO_NAME}/releases/download/${TAG_NAME}/whale-ask-server-${TAG_NAME}-macos-x86_64.tar.gz"
          ARM_URL="https://github.com/${REPO_OWNER}/${REPO_NAME}/releases/download/${TAG_NAME}/whale-ask-server-${TAG_NAME}-macos-aarch64.tar.gz"

          echo "Checking Intel asset: $INTEL_URL"
          if ! curl --head --fail "$INTEL_URL" > /dev/null 2>&1; then
            echo "‚ùå Intel asset not found: $INTEL_URL"
            exit 1
          fi

          echo "Checking ARM asset: $ARM_URL"
          if ! curl --head --fail "$ARM_URL" > /dev/null 2>&1; then
            echo "‚ùå ARM asset not found: $ARM_URL"
            exit 1
          fi

          echo "‚úÖ All release assets verified"

      - name: Calculate SHA256 for release assets
        id: sha256
        run: |
          TAG_NAME="${{ steps.release_info.outputs.tag_name }}"
          REPO_OWNER="${{ github.repository_owner }}"
          REPO_NAME="${{ github.event.repository.name }}"

          INTEL_URL="https://github.com/${REPO_OWNER}/${REPO_NAME}/releases/download/${TAG_NAME}/whale-ask-server-${TAG_NAME}-macos-x86_64.tar.gz"
          ARM_URL="https://github.com/${REPO_OWNER}/${REPO_NAME}/releases/download/${TAG_NAME}/whale-ask-server-${TAG_NAME}-macos-aarch64.tar.gz"

          echo "Downloading and calculating SHA256..."

          curl -L -o /tmp/intel.tar.gz "$INTEL_URL"
          curl -L -o /tmp/arm.tar.gz "$ARM_URL"

          INTEL_SHA256=$(sha256sum /tmp/intel.tar.gz | cut -d' ' -f1)
          ARM_SHA256=$(sha256sum /tmp/arm.tar.gz | cut -d' ' -f1)

          echo "intel_sha256=${INTEL_SHA256}" >> $GITHUB_OUTPUT
          echo "arm_sha256=${ARM_SHA256}" >> $GITHUB_OUTPUT
          echo "intel_url=${INTEL_URL}" >> $GITHUB_OUTPUT
          echo "arm_url=${ARM_URL}" >> $GITHUB_OUTPUT

          echo "Intel SHA256: $INTEL_SHA256"
          echo "ARM SHA256: $ARM_SHA256"

      - name: Checkout homebrew tap repository
        uses: actions/checkout@v4
        with:
          repository: whalesea1314/homebrew-whale-interactive-feedback
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          path: homebrew-tap

      - name: Configure git for homebrew-tap
        run: |
          cd homebrew-tap
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"

      - name: Update Homebrew Formula
        run: |
          TAG_NAME="${{ steps.release_info.outputs.tag_name }}"
          VERSION_NUMBER="${{ steps.release_info.outputs.version_number }}"
          INTEL_SHA256="${{ steps.sha256.outputs.intel_sha256 }}"
          ARM_SHA256="${{ steps.sha256.outputs.arm_sha256 }}"
          INTEL_URL="${{ steps.sha256.outputs.intel_url }}"
          ARM_URL="${{ steps.sha256.outputs.arm_url }}"

          cd homebrew-tap

          if [[ ! -f "Formula/whale-ask-server.rb" ]]; then
            echo "‚ùå Error: Formula/whale-ask-server.rb not found"
            exit 1
          fi

          echo "Updating Formula with:"
          echo "  Version: ${VERSION_NUMBER}"
          echo "  Intel SHA256: ${INTEL_SHA256}"
          echo "  ARM SHA256: ${ARM_SHA256}"

          # Êõ¥Êñ∞ÁâàÊú¨Âè∑
          sed -i "s|version \".*\"|version \"${VERSION_NUMBER}\"|g" Formula/whale-ask-server.rb

          # Êõ¥Êñ∞ Intel URL Âíå SHA256
          sed -i "s|https://github.com/.*/releases/download/v[0-9.]*/whale-ask-server-v[0-9.]*-macos-x86_64.tar.gz|${INTEL_URL}|g" Formula/whale-ask-server.rb
          sed -i "/on_intel do/,/end/ { /sha256/ s|sha256[[:space:]]*\".*\"|sha256  \"${INTEL_SHA256}\"|; }" Formula/whale-ask-server.rb

          # Êõ¥Êñ∞ ARM URL Âíå SHA256
          sed -i "s|https://github.com/.*/releases/download/v[0-9.]*/whale-ask-server-v[0-9.]*-macos-aarch64.tar.gz|${ARM_URL}|g" Formula/whale-ask-server.rb
          sed -i "/on_arm do/,/end/ { /sha256/ s|sha256[[:space:]]*\".*\"|sha256  \"${ARM_SHA256}\"|; }" Formula/whale-ask-server.rb

      - name: Verify Formula changes
        run: |
          cd homebrew-tap
          echo "=== Formula changes ==="
          git diff Formula/whale-ask-server.rb || true
          echo "=== Updated Formula content ==="
          cat Formula/whale-ask-server.rb

      - name: Commit and push to homebrew tap
        run: |
          TAG_NAME="${{ steps.release_info.outputs.tag_name }}"
          VERSION_NUMBER="${{ steps.release_info.outputs.version_number }}"
          cd homebrew-tap

          if git diff --quiet Formula/whale-ask-server.rb; then
            echo "No changes to Formula, skipping commit"
            exit 0
          fi

          git add Formula/whale-ask-server.rb
          git commit -m "chore: update formula to ${TAG_NAME}

          - Update version to ${VERSION_NUMBER}
          - Update download URLs and SHA256 checksums
          - Auto-generated by update-homebrew workflow"

          git push origin main
          echo "‚úÖ Successfully updated homebrew tap"

      - name: Installation instructions
        run: |
          REPO_OWNER="${{ github.repository_owner }}"
          echo "üç∫ Homebrew installation:"
          echo "  brew tap ${REPO_OWNER}/whale-interactive-feedback"
          echo "  brew install whale-ask-server"
